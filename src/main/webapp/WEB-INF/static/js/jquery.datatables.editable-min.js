(function($){$.fn.makeEditable=function(options){var iDisplayStart=0;function fnGetCellID(cell){return properties.fnGetRowID($(cell.parentNode))}function _fnSetRowIDInAttribute(row,id){row.attr("id",id)}function _fnGetRowIDFromAttribute(row){return row.attr("id")}function _fnSetRowIDInFirstCell(row,id){$("td:first",row).html(id)}function _fnGetRowIDFromFirstCell(row){return $("td:first",row).html()}var oTable;var oAddNewRowButton,oDeleteRowButton,oConfirmRowAddingButton,oCancelRowAddingButton;var oAddNewRowForm;var properties;function fnShowError(errorText,action){alert(errorText)}function fnStartProcessingMode(){if(oTable.fnSettings().oFeatures.bProcessing){$(".dataTables_processing").css('visibility','visible')}}function fnEndProcessingMode(){if(oTable.fnSettings().oFeatures.bProcessing){$(".dataTables_processing").css('visibility','hidden')}}var sOldValue,sNewCellValue,sNewCellDislayValue;function _fnApplyEditable(aoNodes){if(properties.bDisableEditing)return;var oDefaultEditableSettings={event:'dblclick',"callback":function(sValue,settings){properties.fnEndProcessingMode();var status="";if(sNewCellValue==sValue){var aPos=oTable.fnGetPosition(this);oTable.fnUpdate(sNewCellDisplayValue,aPos[0],aPos[2]);status="success"}else{var aPos=oTable.fnGetPosition(this);oTable.fnUpdate(sOldValue,aPos[0],aPos[2]);properties.fnShowError(sValue,"update");status="failure"}properties.fnOnEdited(status,sOldValue,sNewCellDisplayValue,aPos[0],aPos[1],aPos[2]);if(settings.fnOnCellUpdated!=null){settings.fnOnCellUpdated(status,sValue,settings)}_fnSetDisplayStart()},"onsubmit":function(settings,original){var input=$("input,select,textarea",this);sOldValue=original.revert;sNewCellValue=$("input,select,textarea",$(this)).val();if(input.length==1){var oEditElement=input[0];if(oEditElement.nodeName.toLowerCase()=="select"||oEditElement.tagName.toLowerCase()=="select")sNewCellDisplayValue=$("option:selected",oEditElement).text();else sNewCellDisplayValue=sNewCellValue}if(!properties.fnOnEditing(input))return false;var x=settings;if(settings.cssclass!=null){input.addClass(settings.cssclass);if(!input.valid()||0==input.valid())return false;else return true}},"submitdata":function(value,settings){iDisplayStart=_fnGetDisplayStart();properties.fnStartProcessingMode();var id=fnGetCellID(this);var rowId=oTable.fnGetPosition(this)[0];var columnPosition=oTable.fnGetPosition(this)[1];var columnId=oTable.fnGetPosition(this)[2];var sColumnName=oTable.fnSettings().aoColumns[columnId].sName;if(sColumnName==null||sColumnName=="")sColumnName=oTable.fnSettings().aoColumns[columnId].sTitle;return{"id":id,"rowId":rowId,"columnPosition":columnPosition,"columnId":columnId,"columnName":sColumnName}},"onerror":function(){properties.fnEndProcessingMode();properties.fnShowError("Cell cannot be updated(Server error)","update");properties.fnOnEdited("failure")},"height":properties.sEditorHeight,"width":properties.sEditorWidth};var cells=null;if(properties.aoColumns!=null){for(var i=0;i<properties.aoColumns.length;i++){if(properties.aoColumns[i]!=null){cells=$("td:nth-child("+(i+1)+")",aoNodes);var oColumnSettings=oDefaultEditableSettings;oColumnSettings=$.extend({},oDefaultEditableSettings,properties.aoColumns[i]);var sUpdateURL=properties.sUpdateURL;try{if(oColumnSettings.sUpdateURL!=null)sUpdateURL=oColumnSettings.sUpdateURL}catch(ex){}cells.editable(sUpdateURL,oColumnSettings)}}}else{cells=$('td:not(.'+properties.sReadOnlyCellClass+')',aoNodes);cells.editable(properties.sUpdateURL,oDefaultEditableSettings)}}function _fnOnRowAdding(event){if(properties.fnOnAdding()){if(oAddNewRowForm.valid()){iDisplayStart=_fnGetDisplayStart();properties.fnStartProcessingMode();var params=oAddNewRowForm.serialize();$.ajax({'url':properties.sAddURL,'data':params,'type':properties.sAddHttpMethod,"dataType":"text",success:_fnOnRowAdded,error:function(response){properties.fnEndProcessingMode();properties.fnShowError(response.responseText,"add");properties.fnOnAdded("failure")}})}}event.stopPropagation();event.preventDefault()}function _fnOnNewRowPosted(data){return true}function _fnOnRowAdded(data){properties.fnEndProcessingMode();if(properties.fnOnNewRowPosted(data)){var oSettings=oTable.fnSettings();var iColumnCount=oSettings.aoColumns.length;var values=new Array();$("input:text[rel],input:radio[rel][checked],input:hidden[rel],select[rel],textarea[rel],span.datafield[rel]",oAddNewRowForm).each(function(){var rel=$(this).attr("rel");var sCellValue="";if(rel>=iColumnCount)properties.fnShowError("In the add form is placed input element with the name '"+$(this).attr("name")+"' with the 'rel' attribute that must be less than a column count - "+iColumnCount,"add");else{if(this.nodeName.toLowerCase()=="select"||this.tagName.toLowerCase()=="select")sCellValue=$("option:selected",this).text();else if(this.nodeName.toLowerCase()=="span"||this.tagName.toLowerCase()=="span")sCellValue=$(this).html();else sCellValue=this.value;sCellValue=sCellValue.replace(properties.sIDToken,data);values[rel]=sCellValue}});var rtn=oTable.fnAddData(values);var oTRAdded=oTable.fnGetNodes(rtn);_fnApplyEditable(oTRAdded);properties.fnSetRowID($(oTRAdded),data);oAddNewRowForm.dialog('close');$(oAddNewRowForm)[0].reset();$(".error",$(oAddNewRowForm)).html("");_fnSetDisplayStart();properties.fnOnAdded("success")}}function _fnOnCancelRowAdding(event){$(oAddNewRowForm).validate().resetForm();$(oAddNewRowForm)[0].reset();$(".error",$(oAddNewRowForm)).html("");$(".error",$(oAddNewRowForm)).hide();oAddNewRowForm.dialog('close');event.stopPropagation();event.preventDefault()}function _fnDisableDeleteButton(){if(properties.oDeleteRowButtonOptions!=null){oDeleteRowButton.button("option","disabled",true)}else{oDeleteRowButton.attr("disabled","true")}}function _fnEnableDeleteButton(){if(properties.oDeleteRowButtonOptions!=null){oDeleteRowButton.button("option","disabled",false)}else{oDeleteRowButton.removeAttr("disabled")}}function _fnDeleteRow(id,sDeleteURL){var sURL=sDeleteURL;if(sDeleteURL==null)sURL=properties.sDeleteURL;properties.fnStartProcessingMode();var data=$.extend(properties.oDeleteParameters,{"id":id});$.ajax({'url':sURL,'type':properties.sDeleteHttpMethod,'data':data,"success":_fnOnRowDeleted,"dataType":"text","error":function(response){properties.fnEndProcessingMode();properties.fnShowError(response.responseText,"delete");properties.fnOnDeleted("failure")}})}function _fnOnRowDelete(event){iDisplayStart=_fnGetDisplayStart();if($('tr.'+properties.sSelectedRowClass+' td',oTable).length==0){_fnDisableDeleteButton();return}var id=fnGetCellID($('tr.'+properties.sSelectedRowClass+' td',oTable)[0]);if(properties.fnOnDeleting($('tr.'+properties.sSelectedRowClass,oTable),id,_fnDeleteRow)){_fnDeleteRow(id)}}function _fnOnRowDeleted(response){properties.fnEndProcessingMode();var oTRSelected=$('tr.'+properties.sSelectedRowClass,oTable)[0];if(response=="ok"||response==""){oTable.fnDeleteRow(oTRSelected);_fnDisableDeleteButton();_fnSetDisplayStart();properties.fnOnDeleted("success")}else{properties.fnShowError(response,"delete");properties.fnOnDeleted("failure")}}function fnOnDeleting(tr,id,fnDeleteRow){return confirm("Are you sure that you want to delete this record?")}function fnOnDeleted(result){}function fnOnEditing(input){return true}function fnOnEdited(result,sOldValue,sNewValue,iRowIndex,iColumnIndex,iRealColumnIndex){}function fnOnAdding(){return true}function fnOnAdded(result){}var oSettings;function _fnGetDisplayStart(){return oSettings._iDisplayStart}function _fnSetDisplayStart(){if(oSettings.oFeatures.bServerSide===false){oSettings._iDisplayStart=iDisplayStart;oSettings.oApi._fnCalculateEnd(oSettings);oSettings.oApi._fnDraw(oSettings)}}oTable=this;var defaults={sUpdateURL:"UpdateData",sAddURL:"AddData",sDeleteURL:"DeleteData",sAddNewRowFormId:"formAddNewRow",oAddNewRowFormOptions:{autoOpen:false,modal:true},sAddNewRowButtonId:"btnAddNewRow",oAddNewRowButtonOptions:null,sAddNewRowOkButtonId:"btnAddNewRowOk",sAddNewRowCancelButtonId:"btnAddNewRowCancel",oAddNewRowOkButtonOptions:{label:"Ok"},oAddNewRowCancelButtonOptions:{label:"Cancel"},sDeleteRowButtonId:"btnDeleteRow",oDeleteRowButtonOptions:null,sSelectedRowClass:"row_selected",sReadOnlyCellClass:"read_only",sAddDeleteToolbarSelector:".add_delete_toolbar",fnShowError:fnShowError,fnStartProcessingMode:fnStartProcessingMode,fnEndProcessingMode:fnEndProcessingMode,aoColumns:null,fnOnDeleting:fnOnDeleting,fnOnDeleted:fnOnDeleted,fnOnAdding:fnOnAdding,fnOnNewRowPosted:_fnOnNewRowPosted,fnOnAdded:fnOnAdded,fnOnEditing:fnOnEditing,fnOnEdited:fnOnEdited,sAddHttpMethod:'POST',sDeleteHttpMethod:'POST',fnGetRowID:_fnGetRowIDFromAttribute,fnSetRowID:_fnSetRowIDInAttribute,sEditorHeight:"100%",sEditorWidth:"100%",bDisableEditing:false,oDeleteParameters:{},sIDToken:"DATAROWID"};properties=$.extend(defaults,options);oSettings=oTable.fnSettings();return this.each(function(){if(oTable.fnSettings().sAjaxSource!=null){oTable.fnSettings().aoDrawCallback.push({"fn":function(){_fnApplyEditable(oTable.fnGetNodes());$(oTable.fnGetNodes()).each(function(){var position=oTable.fnGetPosition(this);var id=oTable.fnGetData(position)[0];properties.fnSetRowID($(this),id)})},"sName":"fnApplyEditable"})}else{_fnApplyEditable(oTable.fnGetNodes())}oAddNewRowForm=$("#"+properties.sAddNewRowFormId);if(oAddNewRowForm.length!=0){if(properties.oAddNewRowFormOptions!=null){properties.oAddNewRowFormOptions.autoOpen=false}else{properties.oAddNewRowFormOptions={autoOpen:false}}oAddNewRowForm.dialog(properties.oAddNewRowFormOptions);oAddNewRowButton=$("#"+properties.sAddNewRowButtonId);if(oAddNewRowButton.length!=0){oAddNewRowButton.click(function(){oAddNewRowForm.dialog('open')})}else{if($(properties.sAddDeleteToolbarSelector).length==0){throw"Cannot find a button with an id '"+properties.sAddNewRowButtonId+"', od placeholder with an id '"+properties.sAddDeleteToolbarSelector+"' that should be used for adding new row although form for adding new record is specified";}else{oAddNewRowButton=null}}if(oAddNewRowForm[0].nodeName.toLowerCase()=="form"){oAddNewRowForm.unbind('submit');oAddNewRowForm.submit(function(event){_fnOnRowAdding(event);return false})}else{$("form",oAddNewRowForm[0]).unbind('submit');$("form",oAddNewRowForm[0]).submit(function(event){_fnOnRowAdding(event);return false})}var aAddNewRowFormButtons=[];oConfirmRowAddingButton=$("#"+properties.sAddNewRowOkButtonId,oAddNewRowForm);if(oConfirmRowAddingButton.length==0){if(properties.oAddNewRowOkButtonOptions.text==null||properties.oAddNewRowOkButtonOptions.text==""){properties.oAddNewRowOkButtonOptions.text="Ok"}properties.oAddNewRowOkButtonOptions.click=_fnOnRowAdding;properties.oAddNewRowOkButtonOptions.id=properties.sAddNewRowOkButtonId;aAddNewRowFormButtons.push(properties.oAddNewRowOkButtonOptions)}else{oConfirmRowAddingButton.click(_fnOnRowAdding)}oCancelRowAddingButton=$("#"+properties.sAddNewRowCancelButtonId);if(oCancelRowAddingButton.length==0){if(properties.oAddNewRowCancelButtonOptions.text==null||properties.oAddNewRowCancelButtonOptions.text==""){properties.oAddNewRowCancelButtonOptions.text="Cancel"}properties.oAddNewRowCancelButtonOptions.click=_fnOnCancelRowAdding;properties.oAddNewRowCancelButtonOptions.id=properties.sAddNewRowCancelButtonId;aAddNewRowFormButtons.push(properties.oAddNewRowCancelButtonOptions)}else{oCancelRowAddingButton.click(_fnOnCancelRowAdding)}if(aAddNewRowFormButtons.length>0){oAddNewRowForm.dialog('option','buttons',aAddNewRowFormButtons)}oConfirmRowAddingButton=$("#"+properties.sAddNewRowOkButtonId);oCancelRowAddingButton=$("#"+properties.sAddNewRowCancelButtonId)}else{oAddNewRowForm=null}oDeleteRowButton=$('#'+properties.sDeleteRowButtonId);if(oDeleteRowButton.length!=0)oDeleteRowButton.click(_fnOnRowDelete);else{oDeleteRowButton=null}oAddDeleteToolbar=$(properties.sAddDeleteToolbarSelector);if(oAddDeleteToolbar.length!=0){if(oAddNewRowButton==null&&properties.sAddNewRowButtonId!=""&&oAddNewRowForm!=null){oAddDeleteToolbar.append("<button id='"+properties.sAddNewRowButtonId+"' class='add_row'>Add</button>");oAddNewRowButton=$("#"+properties.sAddNewRowButtonId);oAddNewRowButton.click(function(){oAddNewRowForm.dialog('open')})}if(oDeleteRowButton==null&&properties.sDeleteRowButtonId!=""){oAddDeleteToolbar.append("<button id='"+properties.sDeleteRowButtonId+"' class='delete_row'>Delete</button>");oDeleteRowButton=$("#"+properties.sDeleteRowButtonId);oDeleteRowButton.click(_fnOnRowDelete)}}if(oDeleteRowButton!=null){if(properties.oDeleteRowButtonOptions!=null){oDeleteRowButton.button(properties.oDeleteRowButtonOptions)}_fnDisableDeleteButton()}if(oAddNewRowButton!=null){if(properties.oAddNewRowButtonOptions!=null){oAddNewRowButton.button(properties.oAddNewRowButtonOptions)}}if(oConfirmRowAddingButton!=null){if(properties.oAddNewRowOkButtonOptions!=null){oConfirmRowAddingButton.button(properties.oAddNewRowOkButtonOptions)}}if(oCancelRowAddingButton!=null){if(properties.oAddNewRowCancelButtonOptions!=null){oCancelRowAddingButton.button(properties.oAddNewRowCancelButtonOptions)}}$(".table-action-deletelink",oTable).live("click",function(e){e.preventDefault();e.stopPropagation();var sURL=$(this).attr("href");if(sURL==null||sURL=="")sURL=properties.sDeleteURL;iDisplayStart=_fnGetDisplayStart();var oTD=($(this).parents('td'))[0];var oTR=($(this).parents('tr'))[0];$(oTR).addClass(properties.sSelectedRowClass);var id=fnGetCellID(oTD);if(properties.fnOnDeleting(oTD,id,_fnDeleteRow)){_fnDeleteRow(id,sURL)}});$("tbody",oTable).click(function(event){if($(event.target.parentNode).hasClass(properties.sSelectedRowClass)){$(event.target.parentNode).removeClass(properties.sSelectedRowClass);if(oDeleteRowButton!=null){_fnDisableDeleteButton()}}else{$(oTable.fnSettings().aoData).each(function(){$(this.nTr).removeClass(properties.sSelectedRowClass)});$(event.target.parentNode).addClass(properties.sSelectedRowClass);if(oDeleteRowButton!=null){_fnEnableDeleteButton()}}})})}})(jQuery);